!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("youme-im/voice")):"function"==typeof define&&define.amd?define(["youme-im/voice"],n):t.WAVRecorder=n(t.VoiceMessage)}(this,function(t){t=t&&t.hasOwnProperty("default")?t.default:t;var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])};"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var n,e=(function(t,n){var s,i;t.exports=(s=function(){var h,l=0,d=[],v=[];function w(t,n){for(var i=new Float32Array(n),o=0,e=0;e<t.length;e++)i.set(t[e],o),o+=t[e].length;return i}function m(t,n,i){for(var o=0;o<i.length;o++)t.setUint8(n+o,i.charCodeAt(o))}self.onmessage=function(t){switch(t.data.command){case"init":c=t.data.config,h=c.sampleRate;break;case"record":a=t.data.buffer,d.push(a[0]),v.push(a[1]),l+=a[0].length;break;case"exportWAV":i=t.data.type,o=w(d,l),e=w(v,l),u=function(t,n){for(var i=t.length+n.length,o=new Float32Array(i),e=0,r=0;e<i;)o[e++]=t[r],o[e++]=n[r],r++;return o}(o,e),f=new ArrayBuffer(44+2*u.length),m(s=new DataView(f),0,"RIFF"),s.setUint32(4,36+2*u.length,!0),m(s,8,"WAVE"),m(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,2,!0),s.setUint32(24,h,!0),s.setUint32(28,4*h,!0),s.setUint16(32,4,!0),s.setUint16(34,16,!0),m(s,36,"data"),s.setUint32(40,2*u.length,!0),function(t,n,i){for(var o=0;o<i.length;o++,n+=2){var e=Math.max(-1,Math.min(1,i[o]));t.setInt16(n,e<0?32768*e:32767*e,!0)}}(s,44,u),r=new Blob([s],{type:i}),self.postMessage({type:"blob",data:r});break;case"getBuffer":(n=[]).push(w(d,l)),n.push(w(v,l)),self.postMessage({type:"buffer",data:n});break;case"clear":l=0,d=[],v=[]}var n,i,o,e,r,u,f,s,a,c}}.toString().replace(/^\s*function.*?\(\)\s*{/,"").replace(/}\s*$/,""),(i=function(t,n){var i=n||{},o=i.bufferLen||4096;this.context=t.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,o,2,2);var e=new Worker((window.URL||window.webkitURL).createObjectURL(new Blob([s],{type:"text/javascript"})));e.onmessage=function(t){"blob"===t.data.type?u(t.data.data):r(t.data.data)},e.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}});var r,u,f=!1;this.node.onaudioprocess=function(t){f&&e.postMessage({command:"record",buffer:[t.inputBuffer.getChannelData(0),t.inputBuffer.getChannelData(1)]})},this.configure=function(t){for(var n in t)t.hasOwnProperty(n)&&(i[n]=t[n])},this.record=function(){f=!0},this.stop=function(){f=!1},this.clear=function(){e.postMessage({command:"clear"})},this.getBuffer=function(t){r=t||i.callback,e.postMessage({command:"getBuffer"})},this.exportWAV=function(t,n){if(u=t||i.callback,n=n||i.type||"audio/wav",!u)throw new Error("Callback not set");e.postMessage({command:"exportWAV",type:n})},this.release=function(){this.stop(),this.clear(),this.configure=this.record=this.stop=this.clear=this.getBuffer=this.exportWAV=function(){},t.disconnect(this.node),this.node.onaudioprocess=null,this.node.disconnect(),e.terminate()},t.connect(this.node),this.node.connect(this.context.destination)}).forceDownload=function(t,n){var i=(window.URL||window.webkitURL).createObjectURL(t),o=window.document.createElement("a");o.href=i,o.download=n||"output.wav";var e=document.createEvent("Event");e.initEvent("click",!0,!0),o.dispatchEvent(e)},i)}(n={exports:{}},n.exports),n.exports);return function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.t=null,t.n=null,t.i=null,t.o={},t.e=function(){},t.r=function(){},t.u=null,t.f=!1,t.s=null,t.a=!1,t.c=!1,t.typeId=3,t.typeName="wav",t}return function(t,n){function i(){this.constructor=t}o(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}(t,n),t.prototype.isEnvSupport=function(){return!!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)},t.prototype.isSupportMsg=function(t){return"object"==typeof t&&"string"==typeof t.downloadurl&&/(\.amr|\.mp3|\.m4a|\.wav)(\?|$)/.test(t.downloadurl)},t.prototype.initRecord=function(){var i=this;return this.t=new AudioContext,navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){var n=i.t.createMediaStreamSource(t);i.i=new e(n),i.f=!0}).catch(function(t){return console.log("Unable to get stream...",t)})},t.prototype.startRecord=function(){var t=this;!1!==this.f&&(this.i.clear(),this.i.record(),this.a=!0,setTimeout(function(){!0===t.a&&t.finishRecord().then(function(){})},6e4))},t.prototype.finishRecord=function(){var e=this;return this.i.stop(),this.a=!1,this.i.getBuffer(function(t){e.u=t;var n=e.t.createBuffer(t.length,t[0].length,e.t.sampleRate);if(n.copyToChannel)for(var i=0,o=t.length;i<o;i++)n.copyToChannel(t[i],i,0);else for(i=0,o=t.length;i<o;i++){n.getChannelData(i).set(t[i])}e.s=n}),new Promise(function(i){e.i.exportWAV(function(n){e.uploadFile(n).then(function(t){e.o={datasize:n.size,downloadurl:t,recordmode:3,voicetime:e.getDuration().toFixed(2)},e.e(),e.i.release(),i()})},"audio/wav")})},t.prototype.cancelRecord=function(){this.i.release(),this.a=!1},t.prototype.isRecording=function(){return this.a},t.prototype.onRecordEnd=function(t){this.e=t},t.prototype.getJsonMsg=function(){return this.o},t.prototype.initWithJsonMsg=function(t){return this.o=t,this.t=new AudioContext,this.h(t.downloadurl)},t.prototype.h=function(o){var n=this;return new Promise(function(t,n){var i=new XMLHttpRequest;i.open("GET",o,!0),i.responseType="arraybuffer",i.onload=function(){t(this.response)},i.onerror=function(){n(new Error("Failed to fetch "+o))},i.send()}).then(function(t){return n.l(t)})},t.prototype.l=function(t){var n=this;return this.t.decodeAudioData(t,function(t){n.s=t},function(t){console.log("Error decoding file",t)})},t.prototype.play=function(){this.stop(),this.n=this.t.createBufferSource(),this.n.buffer=this.s,this.n.loop=!1,this.n.connect(this.t.destination),this.n.onended=this.r,this.n.start(),this.c=!0},t.prototype.stop=function(){this.n&&this.c&&(this.n.stop(),this.c=!1)},t.prototype.isPlaying=function(){return this.c},t.prototype.onPlayEnd=function(t){var n=this;this.r=function(){n.c=!1}},t.prototype.getDuration=function(){var t=this.f?this.t.sampleRate:44100;return this.u?this.u[0].length/t:0},t}(t.Recorder)});
