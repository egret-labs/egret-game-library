var __reflect=this&&this.__reflect||function(t,e,s){t.__class__=e,s?s.push(e):s=[e],t.__types__=t.__types__?s.concat(t.__types__):s},__extends=this&&this.__extends||function(t,e){function s(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);s.prototype=e.prototype,t.prototype=new s},GestureRecognizerPlugin=function(){function t(t,e,s,i,o){void 0===t&&(t=""),void 0===e&&(e=0),void 0===s&&(s=!1),void 0===i&&(i=!1),void 0===o&&(o=1),this._failed=!1,this._priority=0,this._numTouchesRequired=1,this._continuous=!1,this._possible=!0,this._gestureType=t,this._continuous=i,this._requireGestureRecognizerToFail=s,this._priority=e||0,this._numTouchesRequired=o}return t.activate=function(t){for(var e=t.length;--e>-1;)GestureManager._gesturePlugins[(new t[e])._gestureName]=t[e]},t.prototype._onInitGesture=function(t,e,s){return this._callBack=t,this._config=e,this._g=s,null!=this._config&&null!=this._config.shouldReceiveTouch&&(this._shouldReceiveTouch=this._config.shouldReceiveTouch),this._result=new GestureEvent(GestureEvent.ACHE_GESTURE,this._g),!0},t.prototype.executeGestureRecognizedCallback=function(){this._callBack.recognized&&(this._result.state=GestureState.RECOGNIZED,this._callBack.recognized(this._result))},t.prototype.checkGesture=function(t){return!1},t.prototype.updateValue=function(t){return!0},t.prototype.gesturePossible=function(t){this._possible=t,this._callBack.possible&&(this._result.state=GestureState.POSSIBLE,this._result.possible=t,this._callBack.possible(this._result))},t.prototype.gestureBegan=function(){this._callBack.began&&(this._result.state=GestureState.BEGAN,this._callBack.began(this._result))},t.prototype.gestureEnded=function(){this._callBack.ended&&(this._result.state=GestureState.ENDED,this._callBack.ended(this._result))},t}();__reflect(GestureRecognizerPlugin.prototype,"GestureRecognizerPlugin");var PinchGestureRecognizer=function(t){function e(e,s){void 0===e&&(e=0),void 0===s&&(s=!1);var i=t.call(this,GestureType.PINCH,e,s,!0,2)||this;return i._cx=0,i._cy=0,i._offsetX=0,i._offsetY=0,i.pZero=new egret.Point,i}return __extends(e,t),e.prototype.checkGesture=function(t){if(2!=t.length)return this._cx=0,this._offsetX=this._offsetY=0,!1;var e=t[0],s=t[1];return e.type==egret.TouchEvent.TOUCH_END||s.type==egret.TouchEvent.TOUCH_END?(this._cx=0,this._offsetX=this._offsetY=0,!1):0!=this._cx?!0:(this._cx=.5*(e.stageX+s.stageX),this._cy=.5*(e.stageY+s.stageY),this._d1X=e.stageX-s.stageX,this._d1Y=e.stageY-s.stageY,this._localLocation=this._g.target.globalToLocal(this._cx,this._cy,this._localLocation),this._callBack.changed&&(this._result.dx=this._offsetX,this._result.dy=this._offsetY,this._result.dScale=1,this._result.localLocation=this._localLocation,this.gestureBegan()),!0)},e.prototype.updateValue=function(t){if(2!=t.length)return this._cx=0,!1;var e=t[0],s=t[1];if(e.type==egret.TouchEvent.TOUCH_END||s.type==egret.TouchEvent.TOUCH_END)return this._cx=0,this._offsetX=this._offsetY=0,this.gestureEnded(),!1;var i=this._cx,o=this._cy;this._cx=.5*(e.stageX+s.stageX),this._cy=.5*(e.stageY+s.stageY),this._offsetX=this._cx-i,this._offsetY=this._cy-o,this._d2X=e.stageX-s.stageX,this._d2Y=e.stageY-s.stageY,this._localLocation=this._g.target.globalToLocal(this._cx,this._cy,this._localLocation);var r=egret.Point.distance(new egret.Point(this._d2X,this._d2Y),this.pZero)/egret.Point.distance(new egret.Point(this._d1X,this._d1Y),this.pZero);return this._d1X=this._d2X,this._d1Y=this._d2Y,this._callBack.changed&&(this._result.dx=this._offsetX,this._result.dy=this._offsetY,this._result.dScale=r,this._result.localLocation=this._localLocation,this._callBack.changed(this._result)),!0},e}(GestureRecognizerPlugin);__reflect(PinchGestureRecognizer.prototype,"PinchGestureRecognizer");var DoubleTapGestureRecognizer=function(t){function e(e,s){void 0===e&&(e=0),void 0===s&&(s=!1);var i=t.call(this,GestureType.DOUBLE_TAP,e,s)||this;return i._interval=300,i._max_dist=80,i._count=0,i._validate=!1,i._sx=0,i._sy=0,i._t=new egret.Timer(i._interval,1),i._t.addEventListener(egret.TimerEvent.TIMER,i.onCheck,i),i._count=0,i}return __extends(e,t),e.prototype.checkGesture=function(t){var e,s=t[0];return s.type==egret.TouchEvent.TOUCH_BEGIN&&0==this._count&&(this._failed=!1),s.type==egret.TouchEvent.TOUCH_MOVE,s.type==egret.TouchEvent.TOUCH_END&&(0==this._count?(this._count+=1,this._validate=!0,this._t.reset(),this._t.start(),this._sx=s.stageX,this._sy=s.stageY):1==this._count&&(this._validate&&Math.abs(s.stageX-this._sx)<this._max_dist&&Math.abs(s.stageY-this._sy)<this._max_dist&&(e=!0),this._count=0,this._t.stop())),e},e.prototype.onCheck=function(t){this._failed=!0,this._validate=!1,this._count=0,this._requireGestureRecognizerToFail&&this._g.gestureRecognizerStateChange(this._gestureType,!1)},e}(GestureRecognizerPlugin);__reflect(DoubleTapGestureRecognizer.prototype,"DoubleTapGestureRecognizer");var PropGesture=function(){function t(t,e,s,i,o,r,n,_){void 0===e&&(e="executeGestureRecognizedCallback"),void 0===s&&(s="checkGesture"),void 0===i&&(i="updateValue"),void 0===o&&(o=null),void 0===r&&(r=!1),void 0===n&&(n=0),void 0===_&&(_=1),this.n=0,this.p=!0,this.pr=0,this.t=t,this.c=r,o&&(o._prev=this,this._next=o),this.p0=e,this.p1=s,this.p2=i,this.n=_}return t}();__reflect(PropGesture.prototype,"PropGesture");var GestureEvent=function(t){function e(e,s,i){void 0===i&&(i="");var o=t.call(this,e,!1,null)||this;return o.gm=s,o.state=i,o}return __extends(e,t),e.ACHE_GESTURE="acheGesture",e}(egret.Event);__reflect(GestureEvent.prototype,"GestureEvent");var GestureType=function(){function t(){}return t.DOUBLE_TAP="doubleTap",t.PINCH="pinch",t}();__reflect(GestureType.prototype,"GestureType");var GestureState=function(){function t(){}return t.POSSIBLE="possible",t.RECOGNIZED="recognized",t.FAILED="failed",t.BEGAN="began",t.CHANGED="changed",t.ENDED="ended",t.CANCELLED="cancelled",t}();__reflect(GestureState.prototype,"GestureState");var GestureManager=function(){function t(t,e,s){void 0===e&&(e=null),void 0===s&&(s=!1),this._ref={},this._ts=[],this._touchEventPool=[],this.vars=e||{},this.target=t,t.touchEnabled=!0,this._allowSimultaneous=s,this._initGesture()}return t.prototype._initGesture=function(){var e,s;for(e in this.vars)e in t._gesturePlugins&&(s=new t._gesturePlugins[e])._onInitGesture(this.vars[e],this.vars[e].config,this)&&(this._firstG=new PropGesture(s,"executeGestureRecognizedCallback","checkGesture","updateValue",this._firstG,s._continuous,s._priority,s._numTouchesRequired),this._ref[s._gestureType]=this._firstG);this.linkGestureCondition(),this.target.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouched,this),this.target.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouched,this),this.target.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouched,this),egret.MainContext.instance.stage.addEventListener(egret.Event.LEAVE_STAGE,this.leaveStage,this)},t.prototype.leaveStage=function(t){for(;this._ts.length>0;){var e=this._ts.splice(0,1)[0];this._touchEventPool.push(e)}},t.prototype.linkGestureCondition=function(){for(var t=this._firstG;t;){if(t.t._callBack.hasOwnProperty("requireGestureToFail")&&null!=t.t._callBack.requireGestureToFail){var e=this._ref[t.t._callBack.requireGestureToFail.type];t._f=e,e._o=t,e.t._requireGestureRecognizerToFail=!0,t.t._requireGestureRecognizerToFail=!0}t=t._next}},t.prototype.gestureRecognizerStateChange=function(t,e){var s,i=this._ref[t];if(null!=i._o?e?(i.t[i.p0](),i._o.h&&(i._o.h=!1),i.r=!0,i.c&&(s=this._allowSimultaneous?null:i),s=i):(i.f=!0,i._o.h&&(i._o.t[i._o.p0](),i._o.c&&(i._o.r=!0),i.f=!1,i._o.h=!1)):e&&(i.t[i.p0](),i.r=!0,s=i),null!=s)for(i=this._firstG;i;){if(i==s){i!=this._firstG&&(i._prev._next=i._next,null!=i._next&&(i._next._prev=i._prev),this._firstG._prev=i,i._next=this._firstG,i._prev=null,this._firstG=i);break}i=i._next}},t.prototype.removeTouch=function(t){for(var e=0;e<this._ts.length;e++)if(this._ts[e].touchPointID==t.touchPointID){var s=this._ts.splice(e,1)[0];this._touchEventPool.push(s);break}},t.prototype.cloneTouchEvent=function(t){var e=this._touchEventPool.pop();return e||(e={}),e.stageX=t.stageX,e.stageY=t.stageY,e.type=t.type,e.touchDown=t.touchDown,e.touchPointID=t.touchPointID,e},t.prototype.onTouched=function(t){function e(){var t=r._firstG;if(null!=t&&(!t.r||t.c||(t.r=!1,r._allowSimultaneous)))if(t.r&&!r._allowSimultaneous&&t.c)t.r=t.t[t.p2](s);else{for(var e;t;){if(null!=t.t._shouldReceiveTouch&&!t.t._shouldReceiveTouch())return void(t=t._next);var i=t.n>=o?t.t[t.p1](s):!1;i?(null!=t._o&&t._o.h&&(t._o.h=!1),null!=t._f?t._f.r?(t._f.c||(t._f.r=!1),t=t._next):t._f.f?(null!=t._o&&t._o.h&&(t._o.h=!1),t._f.f=!1,t.t[t.p0](),null!=t._o&&(t.r=!0),t.c&&(t.r=!0,t.t[t.p2](s),e=r._allowSimultaneous?null:t),t=r._allowSimultaneous?t._next:null):(t.h||(t.h=!0),t=t._next):(null!=t._o&&t._o.h&&(t._o.h=!1),t.t[t.p0](),null!=t._o&&t.c&&(t.r=!0),t.c&&(t.r=!0,t.t[t.p2](s),e=r._allowSimultaneous?null:t),t=r._allowSimultaneous?t._next:null)):null!=t._o?(t.f=t.t._failed,t.f&&t._o.h?(t._o.t[t._o.p0](),t._o.c&&(t._o.t[t._o.p2](s),t._o.r=!0),t.f=!1,t._o.h=!1,t=null):t=t._next):t=t._next}if(null!=e&&!r._allowSimultaneous)for(t=r._firstG;t;){if(t==e){t!=r._firstG&&(t._prev._next=t._next,null!=t._next&&(t._next._prev=t._prev),r._firstG._prev=t,t._next=r._firstG,t._prev=null,r._firstG=t);break}t=t._next}}}this.removeTouch(t),this._ts.push(this.cloneTouchEvent(t));var s=this._ts;if(0!=s.length){var i=s[0],o=s.length;if(i){i.type==egret.TouchEvent.TOUCH_BEGIN&&(this.startGlobalX=i.stageX,this.startGlobalY=i.stageY);var r=this;e(),null!=this.vars.onTouch&&this.vars.onTouch instanceof Function&&this.vars.onTouch(s),t.type==egret.TouchEvent.TOUCH_END&&this.removeTouch(t)}}},t.add=function(e,s,i){void 0===s&&(s=null),void 0===i&&(i=!1);var o=new t(e,s,i);if(null==t._gestures[e.hashCode])t._gestures[e.hashCode]=[o];else{var r=t._gestures[e.hashCode];r.push(o)}return o},t.removeAll=function(e){var s=t._gestures[e.hashCode];if(s&&s.length>0){for(var i=0;i<s.length;i++)s[i].dispose();s.length=0}},t.prototype.add=function(e){var s,i;for(s in e)s in t._gesturePlugins&&(i=new t._gesturePlugins[s])._onInitGesture(e[s],e[s].config,this)&&(this._firstG=new PropGesture(i,"executeGestureRecognizedCallback","checkGesture","updateValue",this._firstG,i._continuous,i._priority,i._numTouchesRequired),this._ref[i._gestureType]=this._firstG)},t.prototype.remove=function(t){for(var e,s=this._firstG;s;)s.t._gestureType==t&&(e=s,null!=e._prev&&(e._prev._next=e._next),null!=e._next&&(e._next._prev=e._prev),e==this._firstG&&(this._firstG=e._next)),s=s._next;return null!=e},t.prototype.dispose=function(){this.target.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouched,this),this.target.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouched,this),this.target.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouched,this),egret.MainContext.instance.stage.removeEventListener(egret.Event.LEAVE_STAGE,this.leaveStage,this)},Object.defineProperty(t.prototype,"allowSimultaneous",{get:function(){return this._allowSimultaneous},set:function(t){this._allowSimultaneous=t},enumerable:!0,configurable:!0}),t._gesturePlugins={doubleTap:DoubleTapGestureRecognizer,pinch:PinchGestureRecognizer},t._gestures={},t}();__reflect(GestureManager.prototype,"GestureManager");